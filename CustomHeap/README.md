Задание к занятию 2 (Custom heap)
Дедлайн 15 марта 2018г. Стоимость задания: 2 балла.

Теоретический материал:
Джефри Рихтер. Windows для профессионалов. Часть 3. Управление памятью.
https://msdn.microsoft.com/en-us/library/ms810466.aspx
https://msdn.microsoft.com/en-us/library/ms810603.aspx
https://msdn.microsoft.com/en-us/library/ms810627.aspx

Требуется реализовать менеджер памяти CHeapManager, аналогичный куче.
CHeapManager должен работать не более чем в 10 раз медленнее стандартной кучи.
Менеджер должен поддерживать следующую функциональность:

1. void CHeapManager::Create( int minSize, int maxSize ).
Указание. Используйте VirtualAlloc. При создании кучи в адресном пространстве процесса необходимо зарезервировать непрерывный регион памяти размером maxSize. Части этого региона, размером minSize, необходимо передать физическую память (commit). При работе с памятью необходимо учитывать её страничное представление, т.е. округлять minSize вверх до размера страницы (4Кб).

2. void* CHeapManager::Alloc(int size).
Для эффективной работы метода предлагается:
- Выдавать блоки кратные 4 байтам.
- Передавать физическую память только по мере необходимости. Для этого создайте массив pages целых чисел по количеству страниц. Для каждой страницы храните количество занятых блоков, лежащих на этой странице.
- Записывать в начало выделенной памяти аллокируемый размер (чтобы CHeapManager::Free знал, сколько освобождать),
- Объединяйте свободные блоки. Для этого при освобождении блока нужно эффективно (за O(log n)) узнать свободный блок слева от него и справа от него. Проверить, что они касаются и объединить.
- Хранить несколько set/hash_table свободных блоков памяти разного размера (блоки размером меньше 4 КБ, от 4 до 128 КБ, больше 128 КБ). В блоках меньше 4Кб размер можно хранить в самих блоках. Такие блоки находятся в закоммиченной памяти, т.к. справа и слева от них должны быть занятые блоки. В блоках больше 4Кб размер нельзя хранить в самом блоке, поэтому рекомендуется хранить сет пар <адрес, размер>.

3. void CHeapManager::Free(void* mem).
Страницы физической память, которые более не используются, необходимо возвращать системе. Для этого при освобождении следите за моментом, когда pages[i] обнуляется.

4. void CHeapManager::Destroy().
Указание. Используйте VirtualAlloc. Необходимо вернуть системе всю физическую память и освободить зарезервированный регион. В случае, если остались аллокированные участки, необходимо вывести их адреса и размер.

Для тестирования полученного менеджера необходимо завести несколько классов разного размера и переопределить в них операторы new и delete.

Также необходимо сравнить эффективность полученного менеджера со стандартной кучей (HeapCreate/HeapAlloc/HeapFree/HeapDestroy). Эффективность необходимо оценить по параметрам: скорость, потребляемая физическая память, фрагментация. Во время сдачи задания разницу нужно продемонстрировать в явном видеw.
